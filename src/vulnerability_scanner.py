"""
Vulnerability Scanner - Scans repositories for security vulnerabilities
"""
import logging
import subprocess
import json
from pathlib import Path
from typing import Dict, List, Any

logger = logging.getLogger(__name__)


class VulnerabilityScanner:
    """Scans code for security vulnerabilities"""
    
    def __init__(self):
        self.results = {}
    
    def scan_repository(self, repo_path: Path) -> Dict[str, Any]:
        """Run all vulnerability scans on a repository"""
        logger.info(f"Scanning {repo_path.name} for vulnerabilities")
        
        results = {
            'repo_name': repo_path.name,
            'repo_path': str(repo_path),
            'vulnerabilities': [],
            'python_dependencies': [],
            'bandit_issues': []
        }
        
        # Check for Python vulnerabilities
        if self._has_python_files(repo_path):
            results['python_dependencies'] = self._scan_python_dependencies(repo_path)
            results['bandit_issues'] = self._run_bandit(repo_path)
        
        # Check for common security issues
        results['common_issues'] = self._check_common_issues(repo_path)
        
        return results
    
    def _has_python_files(self, repo_path: Path) -> bool:
        """Check if repository contains Python files"""
        return any(repo_path.rglob('*.py'))
    
    def _scan_python_dependencies(self, repo_path: Path) -> List[Dict[str, Any]]:
        """Scan Python dependencies for known vulnerabilities using Safety"""
        vulnerabilities = []
        requirements_file = repo_path / 'requirements.txt'
        
        if not requirements_file.exists():
            logger.info("No requirements.txt found, skipping Python dependency scan")
            return vulnerabilities
        
        try:
            logger.info("Running Safety scan on Python dependencies")
            result = subprocess.run(
                ['safety', 'check', '--file', str(requirements_file), '--json'],
                capture_output=True,
                text=True,
                timeout=60
            )
            
            if result.stdout:
                try:
                    safety_data = json.loads(result.stdout)
                    vulnerabilities = safety_data if isinstance(safety_data, list) else []
                except json.JSONDecodeError:
                    logger.warning("Could not parse Safety output")
            
        except subprocess.TimeoutExpired:
            logger.error("Safety scan timed out")
        except FileNotFoundError:
            logger.warning("Safety not installed, skipping dependency scan")
        except Exception as e:
            logger.error(f"Error running Safety scan: {e}")
        
        return vulnerabilities
    
    def _run_bandit(self, repo_path: Path) -> List[Dict[str, Any]]:
        """Run Bandit security linter for Python code"""
        issues = []
        
        try:
            logger.info("Running Bandit security scan")
            result = subprocess.run(
                ['bandit', '-r', str(repo_path), '-f', 'json', '-q'],
                capture_output=True,
                text=True,
                timeout=120
            )
            
            if result.stdout:
                try:
                    bandit_data = json.loads(result.stdout)
                    issues = bandit_data.get('results', [])
                except json.JSONDecodeError:
                    logger.warning("Could not parse Bandit output")
            
        except subprocess.TimeoutExpired:
            logger.error("Bandit scan timed out")
        except FileNotFoundError:
            logger.warning("Bandit not installed, skipping code scan")
        except Exception as e:
            logger.error(f"Error running Bandit scan: {e}")
        
        return issues
    
    def _check_common_issues(self, repo_path: Path) -> List[str]:
        """Check for common security misconfigurations"""
        issues = []
        
        # Check for exposed secrets
        sensitive_files = [
            '.env',
            'config.yml',
            'secrets.yml',
            'credentials.json'
        ]
        
        for file_name in sensitive_files:
            if (repo_path / file_name).exists():
                issues.append(f"Warning: Sensitive file found: {file_name}")
        
        # Check for .git directory (shouldn't be in production)
        if (repo_path / '.git').exists():
            issues.append("Note: .git directory present in repository")
        
        return issues
